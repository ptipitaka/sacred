---
/**
 * Division Component for Tipitaka sections
 * Represents a division/section with a number (e.g., (24.), (25.))
 */

export interface Props {
  number: string;
  book?: string; // Optional book identifier for PageFind metadata
  e?: string; // Edition code (defaults to 'ch')
  v?: string | number; // Volume identifier
  p?: string | number; // Page identifier
  bookNo?: string; // Backward compatibility: legacy volume number
  page?: string | number; // Backward compatibility: legacy page reference
}

const {
  number,
  book = '',
  e = 'ch',
  v = undefined,
  p = undefined,
  bookNo = '',
  page = ''
} = Astro.props;

const volume = (v ?? bookNo ?? '').toString().trim();
const pageRef = (p ?? page ?? '').toString().trim();
const edition = (e ?? 'ch').toString().trim() || 'ch';

// Generate PageFind metadata
const metadataValue = book ? `div:${book}-${number}` : `div:${number}`;
const pageMetadata = pageRef ? `page:${pageRef}` : undefined;
const bookNoMetadata = volume ? `bookNo:${volume}` : undefined;
const tooltipParts = [];

if (volume) {
  tooltipParts.push(`Volume ${volume}`);
}

if (pageRef) {
  tooltipParts.push(`Page ${pageRef}`);
}

const tooltip = tooltipParts.length ? tooltipParts.join(' · ') : undefined;
const hasLink = Boolean(tooltip && volume && pageRef);
const linkHref = hasLink
  ? `/book/?e=${encodeURIComponent(edition)}&v=${encodeURIComponent(volume)}&p=${encodeURIComponent(pageRef)}`
  : undefined;
---

<div 
  data-pagefind-meta={metadataValue} 
  data-pagefind-meta-page={pageMetadata}
  data-pagefind-meta-bookno={bookNoMetadata}
  class="division-section"
  data-division={number}
  data-book={book || undefined}
  data-page={pageRef || undefined}
  title={tooltip}
>
  {hasLink && linkHref ? (
    <a
      class="division-number-link"
      href={linkHref}
      target="_blank"
      rel="noopener noreferrer"
      title={tooltip}
    >
      <span class="division-number">{number}.</span>
    </a>
  ) : (
    <span class="division-number" title={tooltip}>{number}.</span>
  )}
  <div class="division-content">
    <slot />
  </div>
</div>

<style>
  .division-section {
    margin: 1.5rem 0;
    padding: 0;
    position: relative;
  }

  .division-number {
    font-weight: bold;
    color: var(--sl-color-text-accent, #007acc);
    font-size: 1em;
    padding: 0;
    line-height: 1.8;
    margin: 0;
  }

  .division-number-link,
  .division-number {
    position: absolute;
    left: 0;
    top: 0;
    z-index: 1;
  }

  .division-number-link {
    text-decoration: none;
    color: inherit;
    display: inline-block;
  }

  .division-content {
    padding: 0;
    line-height: 1.8;
    margin-top: 0;
    position: relative;
    /* ไม่ใช้ flexbox layout เพื่อไม่ให้ส่งผลต่อ paragraph positioning */
  }

  /* Dark mode support */
  :global([data-theme="dark"]) .division-number,
  :global([data-theme="dark"]) .division-number-link {
    color: var(--sl-color-white);
  }

  /* Responsive design */
  @media (max-width: 640px) {
    .division-section {
      margin: 1rem 0;
    }
    
    .division-number,
    .division-number-link {
      font-size: 1em;
      padding: 0; /* ลบ padding ใน responsive */
    }
  }

  /* Print styles */
  @media print {
    .division-section {
      break-inside: avoid;
      margin: 1rem 0;
    }
    
    .division-number,
    .division-number-link {
      color: #000;
    }
  }
</style>